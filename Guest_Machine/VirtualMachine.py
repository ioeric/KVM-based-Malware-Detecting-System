import subprocess
import os
import pdb

class VitualMachine():
    def __init__(self,vm_name, vm_config):
        self.name = vm_name
        self.ip = vm_config['ip']
        self.tap = 'tap_' + vm_config['tap']
        self.gateway = vm_config['gateway']
        self.detect = vm_config['detect']
        self.system = vm_config['system']
        self.memory = vm_config['memory']
        self.image = self.name+'.img'
        self.vlan = '0'
        self.bridge  = 'br0'
        self.vnc_port = vm_config['vnc_port']
    def create(self):
        if subprocess.call(['tunctl', '-u', 'Eric', '-t', self.tap]) != 0:
            raise Exception('Tap_Create','Fail')
        print 'Successfully created TAP: '+self.tap
        subprocess.call(['ifconfig',self.tap,'up'])
        subprocess.call(['brctl','addif',self.bridge,self.tap])
        #if subprocess.call(['ifconfig', self.name, self.ip, 'netmask', '255.255.255.0']) != 0:
        #    raise Exception('ifconfig','Error')
        #print 'ifconfig done...'
        #if subprocess.call(['route', 'add', 'default','gw',self.gateway]) != 0:
        #    raise Exception('route','Error')
       # print 'route done...'
        if subprocess.call(['ls',self.name+'.img'])==0:
            print 'Image already exists...'
        elif subprocess.call(['mv','./images/'+self.system+'.img','./'+self.image])!=0:
            raise Exception('Image','fail')
        else:
            print 'Copied image...'


    def start(self):
        #pdb.set_trace()
        print 'Starting vm on vnc port 0.0.0.0:', self.vnc_port
        if subprocess.call(['/usr/libexec/qemu-kvm','-enable-kvm','-name',self.name,'-m',self.memory,'-net','nic,vlan=0','-net','tap,vlan=0,ifname=tap_0,script=no','-localtime',self.image])!=0:
            raise Exception('Start_VM','Failed')
        print 'Started VM: '+self.name
        self.stop()
    
    def stop(self):
        print 'Cleaning devices...'
        subprocess.call(['brctl', 'delif', self.bridge, self.tap])
        print 'Deleted '+self.bridge+' from '+self.tap
        subprocess.call(['tunctl', '-d', self.tap])
        print 'Deleted '+ self.tap
        pass
    
    def suspend(self):
        pass

    def delete(self):
        pass

if __name__ == '__main__':
    #subprocess.call('brctl','addbr','br0')
    #subprocess.call('ip','link','set','br0','up')
    #subprocess.call(['ifconfig','br0','192.168.0.1'])
    config = { 'ip':'192.168.1.10', 'tap':'0','gateway':'192.168.0.1',
            'detect':'yes','system':'CentOS','memory':'1024', 'vnc_port':'11111' }
    vm1 = VitualMachine('CentOS1',config)
    vm1.create()
    print 'Starting vm'
    vm1.start()
