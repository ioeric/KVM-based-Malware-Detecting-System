#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <string.h>
#include "Http2file_socket.h"

char MY_SOCK_FILE[100];
int sock;
struct sockaddr_un server;

void sock_file_init(char *name){
	strcpy(MY_SOCK_FILE, name);
}

int sock_init(){
	sock = 	socket(AF_UNIX, SOCK_STREAM, 0);
	if (sock < 0){
		perror("Opening stream socket failed...\n");
		return -1;
	}
	server.sun_family = AF_UNIX;
	strcpy(server.sun_path, MY_SOCK_FILE);

	if ( connect(sock, (struct sockaddr *)&server, sizeof(struct sockaddr_un)) <0 ){
		close(sock);
		perror("Failed to connect to server\n");
		return -2;
	}

	fprintf(stderr,"Connected to server %s\n",MY_SOCK_FILE );
	return 0;
}


// Return 0 if success
// -1 otherwise
int send_msg(char *msg, int length){
	if (sock_init() < 0 ){
		fprintf(stderr, "Cannot init socket");
		return -1;
	}
	fprintf(stderr, "Sending msg: %s", msg);
	if ( write(sock, msg, length) < 0 ){
		fprintf(stderr, "Message failed to be sent: %s",msg);
		return -1;
	} else{
		return 0;
	}
	close(sock);

}
